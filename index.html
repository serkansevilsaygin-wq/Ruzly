<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rüzly Card Shop</title>
<style>
  :root{
    --bg:#0f0426;
    --panel:#f6f4ff;
    --accent:#7a3cff;
    --accent-2:#b88bff;
    --muted:#9b91b3;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#0d0320 0%, #12062a 60%);color:var(--panel);-webkit-font-smoothing:antialiased}
  .container{max-width:1100px;margin:28px auto;padding:20px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
  .logo{display:flex;align-items:center;gap:12px}
  .mark{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 8px 30px rgba(122,60,255,0.18)}
  .searchbar{flex:1;margin-left:14px}
  .searchbar input{width:100%;padding:12px 16px;border-radius:12px;border:none;outline:none;background:rgba(255,255,255,0.04);color:var(--panel);font-size:15px}
  .top-actions{display:flex;gap:8px;align-items:center}
  button.btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;padding:10px 14px;border-radius:10px;color:white;font-weight:600;cursor:pointer;box-shadow:0 8px 20px rgba(122,60,255,0.12)}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--panel);padding:8px 12px;border-radius:10px}
  .smallbtn{padding:6px 8px;font-size:13px}
  main{display:grid;grid-template-columns:330px 1fr;gap:20px}
  .sidebar{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:14px;box-shadow:0 8px 30px rgba(2,2,2,0.4)}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;margin-bottom:12px}
  .product-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:14px}
  .product{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:12px;display:flex;flex-direction:column;gap:10px}
  .product img{width:100%;height:140px;object-fit:cover;border-radius:8px;background:linear-gradient(180deg,#ddd,#bbb)}
  .meta{display:flex;justify-content:space-between;align-items:center;font-size:13px;color:var(--muted)}
  .tag{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.03);font-size:12px}
  .buy-row{display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted)}
  .modal-backdrop{position:fixed;inset:0;background:rgba(3,2,10,0.6);display:none;align-items:center;justify-content:center;z-index:40}
  .modal{width:560px;background:linear-gradient(180deg,#12051f,#0b0416);border-radius:12px;padding:18px;color:var(--panel);box-shadow:0 20px 80px rgba(0,0,0,0.6)}
  .input,textarea,select{width:100%;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:var(--panel);outline:none;margin-bottom:8px}
  .badge{background:#ff3b7a;color:white;padding:2px 6px;border-radius:999px;font-size:12px;margin-left:6px}
  .bell{position:relative;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);cursor:pointer}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  .row{display:flex;gap:8px;align-items:center}
  .muted-small{font-size:13px;color:var(--muted)}
  .googleBtn{background:linear-gradient(90deg,#ffffff,#f1f1f1);color:#111;border-radius:10px;padding:8px 12px;font-weight:700}
  @media (max-width:900px){main{grid-template-columns:1fr} .searchbar{order:3}}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo">
      <div class="mark">CV</div>
      <div>
        <h1 style="margin:0">Rüzly Card Shop</h1>
        <div class="muted" style="font-size:13px">Purple • Futuristic • Live</div>
      </div>
    </div>

    <div class="searchbar">
      <input id="search" placeholder="Search cards, packs, sellers..." />
    </div>

    <div class="top-actions">
      <div id="userArea"></div>
      <div id="notifyArea"></div>
      <button id="signinBtn" class="ghost">Sign in</button>
    </div>
  </header>

  <main>
    <aside class="sidebar">
      <div class="card">
        <h3>Quick Filters</h3>
        <div>
          <label class="muted">Category
            <select id="filterCategory" class="input">
              <option value="">All</option>
              <option>Pack</option>
              <option>Single</option>
              <option>Accessory</option>
            </select>
          </label>
          <label class="muted">Show only in-stock <input type="checkbox" id="inStockOnly" /></label>
          <label class="muted">Sort by
            <select id="sortBy" class="input">
              <option value="new">Newest</option>
              <option value="price_asc">Price ↑</option>
              <option value="price_desc">Price ↓</option>
            </select>
          </label>
        </div>
      </div>

      <div class="card">
        <h3>Your Cart</h3>
        <div id="cartList" class="muted">Cart empty — use Buy on a product</div>
      </div>

      <div class="card">
        <h3>Sell an item</h3>
        <div class="muted">Signed-in users can list items for sale.</div>
        <div style="margin-top:8px"><button id="sellBtn" class="btn">Create Listing</button></div>
      </div>

      <div class="card">
        <h3>Info</h3>
        <div class="muted">Buyers must select Classroom (8-D or 8-C) and a pickup time.</div>
      </div>
    </aside>

    <section>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <h2 style="margin:0">Products</h2>
        <div class="muted" id="productCount">0 items</div>
      </div>

      <div id="products" class="product-list"></div>

      <footer>Made with ♥ —Rüzly Card Shop 4v </footer>
    </section>
  </main>
</div>

<!-- Modal -->
<div id="modalBack" class="modal-backdrop"><div class="modal" id="modalContent"></div></div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
/* -------------------- Firebase -------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyDzGTlPWmfz9gg-0EYvvNjZr0dJahTcMrg",
  authDomain: "ruzly-7af10.firebaseapp.com",
  projectId: "ruzly-7af10"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* -------------------- Helpers -------------------- */
const qs = s=>document.querySelector(s), qsa=s=>document.querySelectorAll(s);
let currentUser=null;
function money(n){ return '₺'+Number(n||0).toFixed(2); }
function escapeHtml(str){ return String(str||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }
function openModal(html){ qs('#modalContent').innerHTML=html; qs('#modalBack').style.display='flex'; }
function closeModal(){ qs('#modalBack').style.display='none'; qs('#modalContent').innerHTML=''; }
function placeholder(title){ 
  const svg=encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='600' height='400'><defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='#7a3cff'/><stop offset='1' stop-color='#b88bff'/></linearGradient></defs><rect width='100%' height='100%' fill='url(#g)'/><text x='50%' y='50%' fill='white' font-size='28' font-family='sans-serif' dominant-baseline='middle' text-anchor='middle'>${escapeHtml(title)}</text></svg>`);
  return `data:image/svg+xml;utf8,${svg}`;
}

/* -------------------- Auth -------------------- */
function showAuthModal(){
  openModal(`<h2 style="margin-top:0">Sign in / Register</h2>
    <div style="display:flex;gap:8px;margin-bottom:10px">
      <button id="tabSign" class="smallbtn ghost">Sign in</button>
      <button id="tabReg" class="smallbtn ghost">Register</button>
      <div style="flex:1"></div>
      <button id="closeModal" class="ghost">Close</button>
    </div>
    <div id="authBody"></div>
    <div class="muted-small" style="margin-top:6px">Or use Google for one-click sign-in.</div>
  `);
  qs('#tabSign').onclick=()=>renderSignForm();
  qs('#tabReg').onclick=()=>renderRegForm();
  qs('#closeModal').onclick=closeModal;
  renderSignForm();
}
function renderSignForm(){
  qs('#authBody').innerHTML=`<input id="si_email" class="input" placeholder="Email" />
    <input id="si_pass" class="input" placeholder="Password" type="password" />
    <div style="display:flex;gap:8px">
      <button id="doSign" class="btn">Sign in</button>
      <button id="doGoogle1" class="googleBtn">Sign in with Google</button>
    </div>
    <div id="authMsg" class="muted-small" style="margin-top:6px"></div>`;
  qs('#doSign').onclick=async()=>{
    const email=qs('#si_email').value.trim();
    const pass=qs('#si_pass').value;
    if(!email.includes('@')){ qs('#authMsg').textContent='Enter valid email'; return; }
    if(!pass || pass.length<6){ qs('#authMsg').textContent='Password min 6 chars'; return; }
    try{ await auth.signInWithEmailAndPassword(email,pass); closeModal(); }catch(e){ qs('#authMsg').textContent=e.message; }
  };
  qs('#doGoogle1').onclick=async()=>{
    const provider=new firebase.auth.GoogleAuthProvider();
    try{
      const result=await auth.signInWithPopup(provider);
      const u=result.user;
      const doc=await db.collection('users').doc(u.uid).get();
      if(!doc.exists) await db.collection('users').doc(u.uid).set({name:u.displayName||'', email:u.email, createdAt:firebase.firestore.FieldValue.serverTimestamp()});
      closeModal();
    }catch(e){ alert('Google sign-in failed: '+e.message); }
  };
}
function renderRegForm(){
  qs('#authBody').innerHTML=`<input id="r_name" class="input" placeholder="Display name" />
    <input id="r_email" class="input" placeholder="Email" />
    <input id="r_pass" class="input" placeholder="Password (min 6)" type="password" />
    <div style="display:flex;gap:8px">
      <button id="doReg" class="btn">Register</button>
      <button id="doGoogle2" class="googleBtn">Register with Google</button>
    </div>
    <div id="authMsg" class="muted-small" style="margin-top:6px"></div>`;
  qs('#doReg').onclick=async()=>{
    const name=qs('#r_name').value.trim();
    const email=qs('#r_email').value.trim();
    const pass=qs('#r_pass').value;
    if(!name){ qs('#authMsg').textContent='Enter display name'; return; }
    if(!email.includes('@')){ qs('#authMsg').textContent='Enter valid email'; return; }
    if(!pass || pass.length<6){ qs('#authMsg').textContent='Password min 6 chars'; return; }
    try{
      const cred=await auth.createUserWithEmailAndPassword(email,pass);
      await cred.user.updateProfile({displayName:name});
      await db.collection('users').doc(cred.user.uid).set({name,email,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
      closeModal();
    }catch(e){ qs('#authMsg').textContent=e.message; }
  };
  qs('#doGoogle2').onclick=async()=>renderSignForm();
}

/* -------------------- User & Notifications -------------------- */
function renderUserArea(){
  if(currentUser){
    qs('#userArea').innerHTML=`<div style="display:flex;gap:10px;align-items:center">
      <div style="font-weight:700">${escapeHtml(currentUser.displayName||currentUser.email)}</div>
      <button id="acctBtn" class="ghost">Account</button>
    </div>`;
    qs('#signinBtn').textContent='Sign out';
    qs('#signinBtn').onclick=()=>auth.signOut();
    qs('#sellBtn').onclick=showSellModal;
    qs('#acctBtn').onclick=showAccountModal;
  } else {
    qs('#userArea').innerHTML='';
    qs('#signinBtn').textContent='Sign in';
    qs('#signinBtn').onclick=showAuthModal;
    qs('#sellBtn').onclick=showAuthModal;
  }
  startNotificationsListener();
}

/* -------------------- Products -------------------- */
const productsEl=qs('#products');
const productCountEl=qs('#productCount');
let itemsUnsub=null;

function startItemsListener(){
  if(itemsUnsub) itemsUnsub();
  itemsUnsub=db.collection('items').orderBy('createdAt','desc').onSnapshot(snapshot=>{
    const arr=[];
    snapshot.forEach(doc=>{ const d=doc.data(); d.id=doc.id; arr.push(d); });
    renderProducts(arr);
  },err=>console.error(err));
}

function renderProducts(items){
  const q=qs('#search').value.toLowerCase();
  const cat=qs('#filterCategory').value;
  const inStockOnly=qs('#inStockOnly').checked;
  const sortBy=qs('#sortBy').value;
  let filtered=items.slice();
  if(q) filtered=filtered.filter(it=>(it.title+(it.desc||'')+(it.ownerName||'')).toLowerCase().includes(q));
  if(cat) filtered=filtered.filter(it=>it.cat===cat);
  if(inStockOnly) filtered=filtered.filter(it=>(it.stock||0)>0);
  if(sortBy==='price_asc') filtered.sort((a,b)=>(a.price||0)-(b.price||0));
  if(sortBy==='price_desc') filtered.sort((a,b)=>(b.price||0)-(a.price||0));
  productCountEl.textContent=`${filtered.length} items`;
  productsEl.innerHTML='';
  if(filtered.length===0){ productsEl.innerHTML=`<div class="muted">No products found.</div>`; return; }
  filtered.forEach(it=>{
    const owner=it.ownerName||'Seller';
    const div=document.createElement('div'); div.className='product';
    div.innerHTML=`<img src="${placeholder(it.title)}" alt="${escapeHtml(it.title)}"/>
      <h3>${escapeHtml(it.title)}</h3>
      <div class="meta"><div class="muted">${escapeHtml(it.desc||'')}</div><div class="tag">${escapeHtml(it.cat||'')}</div></div>
      <div class="buy-row"><div>${money(it.price)}</div><button class="btn smallbtn buyBtn">Buy</button></div>`;
    const buyBtn=div.querySelector('.buyBtn');
    buyBtn.onclick=()=>doBuy(it);
    productsEl.appendChild(div);
  });
}

/* -------------------- Sell Item -------------------- */
function showSellModal(){
  if(!currentUser) return showAuthModal();
  openModal(`<h2 style="margin-top:0">Create Listing</h2>
    <input id="si_title" class="input" placeholder="Title" />
    <input id="si_desc" class="input" placeholder="Description" />
    <input id="si_cat" class="input" placeholder="Category (Pack, Single, Accessory)" />
    <input id="si_price" class="input" placeholder="Price" type="number" />
    <input id="si_stock" class="input" placeholder="Stock quantity" type="number" />
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="doSell" class="btn">Create</button>
      <button id="closeSell" class="ghost">Cancel</button>
    </div>
    <div id="sellMsg" class="muted-small" style="margin-top:6px"></div>`);
  qs('#closeSell').onclick=closeModal;
  qs('#doSell').onclick=async()=>{
    const title=qs('#si_title').value.trim();
    const desc=qs('#si_desc').value.trim();
    const cat=qs('#si_cat').value.trim();
    const price=parseFloat(qs('#si_price').value);
    const stock=parseInt(qs('#si_stock').value);
    if(!title || !cat || !price || !stock){ qs('#sellMsg').textContent='Fill all fields'; return; }
    try{
      await db.collection('items').add({title,desc,cat,price,stock,ownerId:currentUser.uid,ownerName:currentUser.displayName,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
      closeModal();
    }catch(e){ qs('#sellMsg').textContent=e.message; }
  };
}

/* -------------------- Buy Item -------------------- */
async function doBuy(it){
  if(!currentUser) return showAuthModal();
  if(!(it.stock>0)){ alert('Item out of stock'); return; }
  try{
    // Reduce stock
    await db.collection('items').doc(it.id).update({stock:it.stock-1});
    // Record order
    await db.collection('orders').add({itemId:it.id,buyerId:currentUser.uid,buyerName:currentUser.displayName,price:it.price,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
    // Add notification for seller
    await db.collection('notifications').add({ownerId:it.ownerId, buyerName:currentUser.displayName, itemTitle:it.title, createdAt:firebase.firestore.FieldValue.serverTimestamp(), read:false});
    alert('Purchase successful!');
  }catch(e){ alert('Error: '+e.message); }
}

/* -------------------- Notifications -------------------- */
let notifUnsub=null;
function startNotificationsListener(){
  const area=qs('#notifyArea');
  if(notifUnsub) notifUnsub();
  if(!currentUser){ area.innerHTML=''; return; }
  notifUnsub=db.collection('notifications').where('ownerId','==',currentUser.uid).orderBy('createdAt','desc').onSnapshot(snapshot=>{
    let count=0;
    const notifs=[];
    snapshot.forEach(doc=>{
      const d=doc.data(); d.id=doc.id;
      notifs.push(d);
      if(!d.read) count++;
    });
    area.innerHTML=`<div class="bell" id="bellBtn">🔔${count?'<span class="badge">'+count+'</span>':''}</div>`;
    qs('#bellBtn').onclick=()=>showNotifications(notifs);
  });
}
function showNotifications(notifs){
  let html='<h2>Notifications</h2>';
  if(notifs.length===0){ html+='<div class="muted">No notifications</div>'; } 
  else{
    html+='<div style="max-height:400px;overflow-y:auto">';
    notifs.forEach(n=>{
      html+=`<div class="card" style="margin-bottom:6px">
        <strong>${escapeHtml(n.buyerName)}</strong> bought <em>${escapeHtml(n.itemTitle)}</em>
        <div class="muted-small">${n.createdAt?.toDate ? n.createdAt.toDate().toLocaleString() : ''}</div>
      </div>`;
      if(!n.read) db.collection('notifications').doc(n.id).update({read:true});
    });
    html+='</div>';
  }
  html+='<button class="ghost smallbtn" onclick="closeModal()">Close</button>';
  openModal(html);
}

/* -------------------- Account -------------------- */
function showAccountModal(){
  openModal(`<h2>Account</h2>
    <div><strong>${escapeHtml(currentUser.displayName||currentUser.email)}</strong></div>
    <div class="muted-small">${escapeHtml(currentUser.email)}</div>
    <div style="margin-top:10px"><button id="signOutBtn" class="ghost">Sign out</button></div>
    <button class="ghost smallbtn" onclick="closeModal()">Close</button>`);
  qs('#signOutBtn').onclick=()=>auth.signOut();
}

/* -------------------- Init -------------------- */
auth.onAuthStateChanged(u=>{
  currentUser=u;
  renderUserArea();
});

qs('#search').addEventListener('input',()=>startItemsListener());
qs('#filterCategory').addEventListener('change',()=>startItemsListener());
qs('#sortBy').addEventListener('change',()=>startItemsListener());
qs('#inStockOnly').addEventListener('change',()=>startItemsListener());

startItemsListener();
</script>
</body>
</html>
